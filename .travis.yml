sudo: false
cache:
  directories:
  - cache/
language: c
compiler: gcc
env:
  global:
    - PACKAGE=openwrt-ci
  matrix:
    - SDK_URL=https://downloads.openwrt.org/releases/17.01.4/targets/ramips/mt7620/lede-sdk-17.01.4-ramips-mt7620_gcc-5.4.0_musl-1.1.16.Linux-x86_64.tar.xz
    - SDK_URL=https://downloads.openwrt.org/releases/17.01.4/targets/ramips/mt7621/lede-sdk-17.01.4-ramips-mt7621_gcc-5.4.0_musl-1.1.16.Linux-x86_64.tar.xz
before_install:
  - sudo apt-get -qq update
  - sudo apt-get install -y ccache
install:
- mkdir -p $TRAVIS_BUILD_DIR/cache ; cd $TRAVIS_BUILD_DIR/cache
- wget -c $SDK_URL
- mkdir -p $TRAVIS_BUILD_DIR/sdk ; cd $TRAVIS_BUILD_DIR/sdk
- export FILE=$TRAVIS_BUILD_DIR/cache/$(basename $SDK_URL)
- file $FILE
- tar xJf $FILE
- cd $TRAVIS_BUILD_DIR/sdk/lede-sdk-*
- mkdir package/$PACKAGE
- ln -s $TRAVIS_BUILD_DIR/Makefile package/$PACKAGE/
- ln -s $TRAVIS_BUILD_DIR/src package/$PACKAGE/
- mkdir -p $TRAVIS_BUILD_DIR/deploy
script:
- cd $TRAVIS_BUILD_DIR/sdk/lede-sdk-*
- ./scripts/feeds update
- make defconfig
- sed -i 's/CONFIG_SIGNED_PACKAGES=y/# CONFIG_SIGNED_PACKAGES is not set/g' .config
- make tools/install
- make toolchain/install
- make target/compile
- make package/$PACKAGE/prepare
- make package/$PACKAGE/compile V=ss
- make package/$PACKAGE/install
- make package/index
- cd bin/*/base
- find .
- cp *.ipk $TRAVIS_BUILD_DIR/deploy
deploy:
  local-dir: $TRAVIS_BUILD_DIR/deploy
  provider: pages
  skip-cleanup: true
  github-token: $GITHUB_TOKEN  # Set in travis-ci.org dashboard, marked secure
  keep-history: true
  on:
    branch: master
# - chmod a+x $TRAVIS_BUILD_DIR/deploy.sh
#after_success: $TRAVIS_BUILD_DIR/deploy.sh
#before_deploy:
#  git fetch --tags
#deploy:
#  provider: releases
#  api_key:
#    secure: L5yTlbnfbQ1FWuvI/33nv2vSZNj3fAHPdQ2ORNB5lkrzrzdEDX66kLyygLVpIUm0ZeFhlKAujrXFh5w9Gu9v4E3fuhVBZZ13ZDuopyTWmJDTu/xGbb/10WlsixzXZqAgYwvv6XxPQ6CvEUV01lppS1+787bAbJhpJKUYebiD8H8=
#  skip_cleanup: true
#  file_glob: true
#  file: $TRAVIS_BUILD_DIR/*.ipk
#  on:
#    tags: true
#    all_branches: true